# Generated by iptables setup
*raw
:PREROUTING ACCEPT [35083:4728715]
:OUTPUT ACCEPT [32829:58556829]
COMMIT
*nat
:PREROUTING ACCEPT [265238:17328193]
:POSTROUTING ACCEPT [99218:6737833]
:OUTPUT ACCEPT [99218:6737833]
COMMIT
*mangle
:PREROUTING ACCEPT [2753549:558605482]
:INPUT ACCEPT [2753548:558605434]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [3499588:2672923567]
:POSTROUTING ACCEPT [3499600:2672926358]
COMMIT
*filter
:FORWARD ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:Firewall-INPUT - [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -j Firewall-INPUT
-A FORWARD -j Firewall-INPUT

{% if ansible_fqdn in groups['lb'] %}
#haproxy
{% for ip in ansible_all_ipv4_addresses %}
-A Firewall-INPUT -p tcp -d {{ ip }} -m multiport --dports 443,80  -j ACCEPT
{% endfor %}
-A Firewall-INPUT -p tcp -d 127.0.0.1 -m multiport --dports 443,80  -j ACCEPT

#nodes
{% for host in groups['nodes'] %}
{% for ip_address_node in  hostvars[host]['ansible_all_ipv4_addresses'] %}
-A Firewall-INPUT -p tcp -s {{ ip_address_node }} -j ACCEPT
{% endfor %}
{% endfor %}
{% endif %}

{% if ansible_fqdn in groups['nodes'] %}
#haproxy
{% for host in groups['lb'] %}
{% for ip_address_lb in  hostvars[host]['ansible_all_ipv4_addresses'] %}
-A Firewall-INPUT -p tcp -s {{ ip_address_lb }} -m multiport --dports 8080,8081  -j ACCEPT
{% endfor %}
{% endfor %}

#mysql
{% for host in groups['galera_cluster_nodes'] %}
{% for ip_address_mysql in  hostvars[host]['ansible_all_ipv4_addresses'] %}
-A Firewall-INPUT -p tcp -s {{ ip_address_mysql }} --dport 3306 -j ACCEPT
{% endfor %}
{% endfor %}
{% endif %}

{% if ansible_fqdn in groups['galera_cluster_nodes'] %}
#nodes
{% for host in groups['nodes'] %}
{% for ip_address_node in  hostvars[host]['ansible_all_ipv4_addresses'] %}
-A Firewall-INPUT -p tcp -s {{ ip_address_node }} --dport 3306 -j ACCEPT
{% endfor %}
{% endfor %}

#mysql
{% for host in groups['galera_cluster_nodes'] %}
{% for ip_address_mysql in  hostvars[host]['ansible_all_ipv4_addresses'] %}
-A Firewall-INPUT -p tcp -s {{ ip_address_mysql }} -j ACCEPT
{% endfor %}
{% endfor %}
{% endif %}

#master
-A Firewall-INPUT -p tcp -s {{ ansible_local_ip}} --dport 22 -j ACCEPT
-A Firewall-INPUT -p tcp -s {{ admin_local_ip }} --dport 22 -j ACCEPT

-A Firewall-INPUT -p icmp -j ACCEPT
-A Firewall-INPUT -i lo -j ACCEPT
-A Firewall-INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A Firewall-INPUT -j DROP

COMMIT
# Completed
